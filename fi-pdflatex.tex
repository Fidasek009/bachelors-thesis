%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% I, the copyright holder of this work, release this work into the
%% public domain. This applies worldwide. In some countries this may
%% not be legally possible; if so: I grant anyone the right to use
%% this work for any purpose, without any conditions, unless such
%% conditions are required by law.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[
  digital,     %% The `digital` option enables the default options for the digital version of a document. Replace with `printed` to enable the default options for the printed version of a document.
  color,       %% Use color in the printed version of your document
  oneside,     %% The `oneside` option enables one-sided typesetting, which is preferred if you are only going to submit a digital version of your thesis. Replace with `twoside` for double-sided typesetting if you are planning to also print your thesis. For double-sided typesetting, use at least 120 g/m² paper to prevent show-through.
  nosansbold,  %% The `nosansbold` option prevents the use of the sans-serif type face for bold text. Replace with `sansbold` to use sans-serif type face for bold text.
  nocolorbold, %% The `nocolorbold` option disables the usage of the blue color for bold text, instead using black. Replace with `colorbold` to use blue for bold text.
  lof,         %% The `lof` option prints the List of Figures. Replace with `nolof` to hide the List of Figures.
  lot,         %% The `lot` option prints the List of Tables. Replace with `nolot` to hide the List of Tables.
]{fithesis4}
%% The following section sets up the locales used in the thesis.
\usepackage[resetfonts]{cmap} %% We need to load the T2A font encoding
\usepackage[T1,T2A]{fontenc}  %% to use the Cyrillic fonts with Russian texts.
\usepackage[main=english, english, czech]{babel}
%% The following section sets up the metadata of the thesis.
\thesissetup{
    date        = \the\year/\the\month/\the\day,
    university  = mu,
    faculty     = fi,
    type        = bc,
    department  = Institite of Computer Science,
    author      = Bc. Filip Krása,
    gender      = m,
    advisor     = {Mgr. Adrián Rošinec},
    title       = {Virtual Research Environment for a Molecular Dynamics Simulation Experiments},
    keywords    = {Molecular Dynamics, GROMACS, Jupyter, Kubernetes, Rancher, Docker, Python, React, S3, CI/CD, OAuth, OIDC, MDRepo, InvenioRDM, e-INFRA CZ},
    declaration = {%
        I hereby declare... bla bla bla.
        \\
        \\
        I used AI for:
        \begin{itemize}
            \item Google Gemini
            \begin{itemize}
                \item finding and summarizing online articles
            \end{itemize}
            \item GitHub Copilot
            \begin{itemize}
                \item coding
                \item PR reviews
                \item thesis structuring
            \end{itemize}
            \item CodeRabbit
            \begin{itemize}
                \item PR reviews
            \end{itemize}
            \item e-INFRA AI API
            \begin{itemize}
                \item coding
                \item thesis structuring
            \end{itemize}
            \item Visily AI
            \begin{itemize}
                \item UI/UX design
            \end{itemize}
        \end{itemize}
    },
    abstract    = {%
      Molecular dynamics simulations are essential for computational drug discovery and biological research, yet their execution remains hindered by complex parameter configuration, fragmented toolchains, and lack of standardized reproducibility practices. This thesis presents MD Dash, a virtual research environment that unifies the complete simulation workflow within a single web-based platform.

      The system implements a five-stage wizard interface that guides users through: (1) simulation preparation via reproducible Jupyter notebooks that capture all procedural steps; (2) automatic performance tuning that optimizes MPI process count, OpenMP threading, and GPU workload distribution through short benchmark runs; (3) production execution in the tuned configuration; (4) integrated analysis with visualization capabilities; and (5) direct publication to InvenioRDM repository with comprehensive metadata.

      Deployed on e-INFRA CZ infrastructure, MD Dash addresses critical barriers in computational molecular science by automating resource optimization and enforcing provenance tracking without sacrificing workflow flexibility.
    },
    thanks      = {%
      I would like to thank XYZ for XYZ.
    },
    bib         = mddash.bib,
    %% Remove the following line to use the JVS 2018 faculty logo.
    facultyLogo = fithesis-fi,
}
\usepackage{makeidx}      %% The `makeidx` package contains helper commands for index typesetting.
\makeindex
%% These additional packages are used within the document:
\usepackage{paralist} %% Compact list environments
\usepackage{amsmath}  %% Mathematics
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{url}      %% Hyperlinks
\usepackage{markdown} %% Lightweight markup
\usepackage{listings} %% Source code highlighting
\lstset{
  basicstyle      = \ttfamily,
  identifierstyle = \color{black},
  keywordstyle    = \color{blue},
  keywordstyle    = {[2]\color{cyan}},
  keywordstyle    = {[3]\color{olive}},
  stringstyle     = \color{teal},
  commentstyle    = \itshape\color{magenta},
  breaklines      = true,
}
\usepackage{floatrow} %% Putting captions above tables
\floatsetup[table]{capposition=top}
\usepackage[babel]{csquotes} %% Context-sensitive quotation marks
\usepackage{graphicx} %% For including images
\begin{document}
%% The \chapter* command can be used to produce unnumbered chapters:

\chapter{Introduction}
The concept of molecular dynamics (MD) has been with us since the 1950s \textit{[TODO: Replace Wikipedia citation with Alder \& Wainwright, 1959 or similar]}. However the rise of computational power has made it more accessible and practical. It gained a lot of interest during the COVID-19 pandemic where it played a crucial role in the development of vaccines.

The problem current MD scientists are facing is the lack of any standardization in setting up, tuning, running and sharing these simulations. The most popular MD simulation software GROMACS only has a CLI interface so its users heavily rely on custom scripts and manual setup. The MD simulations are also computationally expensive and it is necessary to correctly select hyperparameters such as number of MPI processes or whether to use a GPU or a CPU for certain calculations. These hyperparameters are hard to guess and cost extra time and money if not configured properly. After getting the results, the researcher has to have a separate set of tools for analysis which again increases overhead. After getting through this strenuous process it is very difficult to then reuse the results due to the fact that there is no official repository for sharing molecular dynamics data and it usually relies on the user's custom shell scripts and other non-standard methodologies. This poses a barrier between individual teams and makes collaboration difficult.

MD Dash is a tool we created to address these challenges. It aims to provide scientists with an efficient workflow that integrates simulation, analysis, and data management. It provides an easy to use web interface for setting up, running and analyzing molecular dynamics simulations using GROMACS. It also includes an automatic hyperparameter tuner that optimizes the simulation parameters based on the user's hardware and simulation system. To support reproducibility and data preservation, MD Dash utilizes reusable Jupyter notebooks that record all simulation steps, implements automatic metadata extraction using the Gromacs Metadump tool, and integrates directly with the InvenioRDM repository for publishing simulation results. These features ensure that simulation data is well-documented, standardized, and easily accessible for future use.

During the development of MD Dash, we had the opportunity to collaborate with e-INFRA CZ, which provided us with access to their computing resources and expertise in cloud technologies. This collaboration enabled us to deploy MD Dash on their Kubernetes cluster and expose the service to the public.


\chapter{State of the Art}

This chapter establishes the context for the thesis by reviewing the current landscape of molecular dynamics simulations, the challenges of reproducibility, and the technologies available for building modern research environments.

\section{Molecular Dynamics Simulations}

\textit{TODO: Explain the complexity of MD. Focus on the typical "manual" lifecycle: preparation -> minimization -> equilibration -> production -> analysis. This establishes *why* a workflow tool is needed. Discuss GROMACS specifically as the engine of choice and its CLI nature.}

\section{Reproducibility and Data Management}

\textit{TODO: Discuss the "reproducibility crisis". Why is it hard to reproduce someone else's simulation? (Different versions, missing parameters, unpublished scripts).}

\section{Virtual Research Environments}

\textit{TODO: What exists already? why is it not sufficient?}

\section{Cloud-Native Technologies in Science}

\textit{TODO: Brief overview of Kubernetes and JupyterHub. Why are they becoming the standard for scientific computing? (Scalability, isolation, interactive coding).}


\chapter{Analysis and Design}

\textit{TODO: Connect the dots from Chapter 2. "Because MD helps us understand drug discovery (2.1) but suffers from complexity (2.2), we designed MD Dash with the following goals..."}

\section{Workflow design}

\textit{TODO: Propose the solution to the complexity described in Section 2.1. Explain the decision to break the workflow into 6 distinct steps and contrast this with the unstructured "manual" approach. Justify why this linear wizard approach is better for reproducibility than an open-ended terminal.}

\section{Base platform}

\textit{TODO: Justify the choice of technologies described in 2.4. Why JupyterHub? (Interactive, familiar python environment). Why Kubernetes? (Per-user isolation, resource limits). Contrast with running on a shared SSH node (traditional HPC).}

\section{Simulation engine}

\textit{TODO: Why gromacs?}

\section{New experiment}

\textit{TODO: step 0 - reasons for the 3 options for input files, why we decided to support creating an experiment from an existing one on MDRepo, why we decided to support downloading .pdb files from RCSB PDB, why we decided to support custom notebooks repository}

\section{Setup}

\textit{TODO: step 1 - why we decided to use reusable Jupyter notebooks for the setup, what are the advantages of this approach compared to other similar tools and to the traditional way of running MD simulations, Jupyter notebooks preserve "history" and exact steps of the setup}

\section{Tune}

\textit{TODO: Step 2 - Describe the integration with the "Black Box" tuner service. Focus on the integration contract: Input (system size, atoms) to Output (optimal MPI/OpenMP settings). Do not detail the internal algorithms (genetic algorithms/Ray) as that is separate work. Cite the tuner as an external microservice developed by Adam Ondrejka. Explain the business value: automation of trial-and-error optimization.}

\section{Run}

\textit{TODO: step 3 - talk about why we created MDRun API, why the simulations are not running inside user namespace, all the S3 shenanigans we have to do to make cross-namespace file sharing}

\section{Analyze}

\textit{TODO: step 4 - talk about what analysis tools we decided to integrate and why, talk about live file analysis}

\section{Publish}

\textit{TODO: step 5 - MDRepo magically exists and perfectly fits our needs, talk about why we decided to use it, talk about how it ties back to the setup step for reusability}

\section{User Interface Design}

\textit{TODO: talk about concrete UI design decisions, challenges with combining 4 UIs (dashboard, JupyterHub, JupyterLab, MDRepo)}


\chapter{Architecture and Implementation}

\textit{TODO: Overview of the system. Discuss the high-level "Multi-namespace isolation pattern" where JupyterHub orchestrates per-user environments.}


\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/architecture.png}
    \caption{Architecture overview}
\end{figure}

\section{Tenant Isolation Strategy}

\textit{TODO: Detail the Kubernetes implementation. Discuss the Admin Namespace vs. User Namespaces. Explain the Sidecar Container Pattern where the Pod is composed of JupyterHub Singleuser + Sidecars (API, Auth, Proxy). Mention Resource Quotas which are managed via Rancher project annotations (field.cattle.io/resourceQuota).}

\section{JupyterHub Orchestration}

\textit{TODO: Deep dive into the orchestration logic. Explain the Pre-Spawn Hook Pattern using pre\_spawn\_hook.py which dynamically provisions namespaces and waits for Rancher conditions. Mention values.yaml.tmpl and how it injects sidecars.}

\section{Dashboard API}

\textit{TODO: Backend implementation details. Stack: Flask, SQLAlchemy, Marshmallow. Discuss the Active Record Pattern for database models and the Repository Pattern for centralized logic. Discuss the strategy of auto-generating migrations on startup and storing them in DATA\_DIR (non-standard but robust for this K8s setup).}

\section{User Interface}

\textit{TODO: Frontend architecture. Stack: React, Material-UI, Vite. Describe the distribution where static files are embedded in the Caddy Proxy container. Explain the Runtime Config Injection where window.MDDASH\_CONFIG is injected by Caddy (solves build-once, run-anywhere).}

\section{MDRun API}

\textit{TODO: The simulation execution engine. Mention the Background Polling Pattern with daemon threads querying Kubernetes for job status. Discuss SQLite WAL Mode used for concurrent read/write handling during heavy I/O.}

\section{Caddy Proxy}

\textit{TODO: Explain the Reverse Proxy Pattern. Discuss why Caddy was chosen (websocket support, dynamic config API). efficient static file serving, and its role as an API Gateway that aggregates the backend services.}

\section{Security Architecture}

\textit{TODO: Authentication flow. Discuss Forward Auth using Caddy's forward\_auth directive to offload session validation. Explain Session Management with in-memory store and HMAC-signed state. Mention Component Isolation with non-root containers (UID 1000).}

\section{S3 sync daemon}

\textit{TODO: Discuss the Data Synchronization Sidecar Pattern. Explain how the S3 sync daemon runs as a sidecar container inMD Dash API pod to handle bidirectional file synchronization between local storage and S3 buckets in real-time. Describe why it is not used inside MDRun API (we only need one directional sync there)}

\section{Development Workflow}

\subsection{Unified Development Environment}

\textit{TODO: Describe the custom Dev Container setup. Explain how it solves "works on my machine" issues by standardizing dependencies, VS Code extensions, and linters across the team.}

\subsection{AI-Assisted Implementation}

\textit{TODO: Discuss the integration of Generative AI into the workflow. Mention the creation of `AGENTS.md` and custom GitHub Copilot instructions. Explain how these files provided context and coding standards to the AI, resulting in more accurate and consistent code generation.}

\section{DevOps and Configuration Management}

\textit{TODO: The "Make-based Orchestration" and GitOps flow. Explain Template-Based Configuration using gomplate to render values.yaml.tmpl for Environment Parity (Dev vs. Prod). Discuss Build Pipeline with Makefile orchestration for build, test, push, deploy. Mention Image Tagging Strategy with static dev tag vs. immutable production tags.}

\chapter{Application Walkthrough}

\textit{TODO: app overview without architectural details, just to understand the app itself, then in the next chapter we can go into the technical details of how it works and how it was developed}

The app is accessible at https://mddash.dyn.cloud.e-infra.cz/. After logging in using the e-INFRA OIDC service, the user namespace and pod should start being initialized. Once ready, user will automatically be redirected to the main dashboard. Here they are shown an overview of their existing simulations, the current resource usage and quick links to create a new simulation or access the documentation.

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/dash.png}
    \caption{Dashboard view}
\end{figure}

\section{JupyterHub interface}

\textit{TODO: show the JupyterHub interface and it's features, focus only on the features that are relevant to our app}

\section{New experiment}

When creating a new experiment, the user is presented with a few options:

\begin{enumerate}
    \item Experiment name
    \item Input type:
    \begin{itemize}
        \item Upload own files
        \item Create from an existing experiment on MDRepo by providing its URL
        \item Add PDB ID to download a .pdb file from RCSB PDB
    \end{itemize}
    \item Notebooks repository - optional git repository with custom Jupyter notebooks for setup and analysis, defaults to our official repo: \url{https://github.com/CERIT-SC/mddash-notebooks}
\end{enumerate}

\textit{TODO: image of new experiment form}

\section{Setup}

\textit{TODO: show the Jupyter notebook environment, show the notebook for experiment setup}

\section{Tune}

\textit{TODO: show the tuning interface with the results of the tuning, show how the user can select the best configuration and move on to the next step}

\section{Run}

\textit{TODO: show the interface for running the simulation, show how the user can monitor the simulation progress and resource usage, show how the user can access the simulation output files while the simulation is still running}

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/simulation.png}
    \caption{Running simulation view}
\end{figure}

\section{Analyze}

\textit{TODO: show the analysis tools in the UI, mention that user can also spin up Jupyter notebook, mention analysis of a live simulation}

\section{Publish}

\textit{TODO: show the interface for publishing the simulation to MDRepo, describe the initial user authorization with MDRepo}


\chapter{Evaluation}

\textit{TODO: talk about passing the app to some real users, getting feedback, improving the app based on their feedback, compare MD Dash to other similar tools and to the traditional way of running MD simulations}


\chapter{Conclusion}

\textit{TODO: current state, future work, personal insights}


\chapter*{Bibliography}

\printbibliography[heading=none]

\appendix %% Start the appendices.
\chapter*{An appendix}
Here you can insert the appendices of your thesis.

\end{document}
